<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federated Analytics Platform</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        surface: 'rgba(30, 41, 59, 0.7)', // glassmorphism dark
                        surfaceAlt: 'rgba(15, 23, 42, 0.6)',
                    },
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: #f8fafc;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .gradient-text {
            background: linear-gradient(to right, #818cf8, #c084fc);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-indicator {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 10px currentColor;
        }

        .status-active {
            color: #10b981;
            background-color: #10b981;
        }

        .status-idle {
            color: #f59e0b;
            background-color: #f59e0b;
        }

        .status-error {
            color: #ef4444;
            background-color: #ef4444;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-6">

        <!-- Header -->
        <header class="flex justify-between items-center glass-card p-6">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">Federated Analytics <span
                        class="gradient-text">Live</span></h1>
                <p class="text-sm text-slate-400 mt-1">Privacy-Preserving Collaborative AI</p>
            </div>
            <div class="flex items-center gap-3 bg-surfaceAlt px-4 py-2 rounded-full border border-slate-700/50">
                <span id="global-status-dot" class="status-indicator status-idle"></span>
                <span id="global-status-text" class="text-sm font-medium tracking-wide">Status: Booting</span>
            </div>
        </header>

        <!-- Control Panel -->
        <div class="glass-card p-6 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-4 w-full md:w-auto">
                <div class="flex flex-col">
                    <label for="targetRounds" class="text-xs text-slate-400 uppercase tracking-widest mb-1">Target
                        Rounds</label>
                    <input type="number" id="targetRounds" value="10" min="1" max="100"
                        class="bg-surfaceAlt border border-slate-700/50 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-indigo-500 transition-colors w-32">
                </div>
            </div>
            <div class="flex items-center gap-3 w-full md:w-auto">
                <button id="btnStart" onclick="startFederation()"
                    class="flex-1 md:flex-none px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white font-medium rounded-lg transition-colors shadow-lg shadow-indigo-500/30">
                    Start Federation
                </button>
                <button id="btnStop" onclick="stopFederation()"
                    class="flex-1 md:flex-none px-6 py-2.5 bg-red-500/20 text-red-400 hover:bg-red-500/30 border border-red-500/30 font-medium rounded-lg transition-colors hidden">
                    Stop
                </button>
            </div>
        </div>

        <!-- KPI Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="glass-card p-6 flex flex-col justify-center">
                <h3 class="text-slate-400 text-sm uppercase font-semibold tracking-wider">Round</h3>
                <div class="mt-2 text-4xl font-light">
                    <span id="round-current" class="text-white font-medium">0</span>
                    <span class="text-slate-500 text-2xl">/ <span id="round-max">10</span></span>
                </div>
            </div>

            <div class="glass-card p-6 flex flex-col justify-center">
                <h3 class="text-slate-400 text-sm uppercase font-semibold tracking-wider">Agents Connected</h3>
                <div class="mt-2 text-4xl font-medium text-white" id="agents-count">
                    0
                </div>
            </div>

            <div class="glass-card p-6 flex flex-col justify-center">
                <h3 class="text-slate-400 text-sm uppercase font-semibold tracking-wider">Latest Accuracy</h3>
                <div class="mt-2 text-4xl font-medium text-emerald-400" id="latest-acc">
                    0.0%
                </div>
            </div>

            <div class="glass-card p-6 flex flex-col justify-center">
                <h3 class="text-slate-400 text-sm uppercase font-semibold tracking-wider">Latest Loss</h3>
                <div class="mt-2 text-4xl font-medium text-indigo-400" id="latest-loss">
                    0.00
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Col: Charts -->
            <div class="lg:col-span-2 space-y-6">
                <div class="glass-card p-6 relative">
                    <h2 class="text-lg font-semibold mb-4 text-slate-200">Convergence Metrics</h2>
                    <div style="height: 350px;">
                        <canvas id="convChart"></canvas>
                    </div>
                </div>

                <div class="glass-card p-6">
                    <h2 class="text-lg font-semibold mb-4 text-slate-200">Global Model Attributes</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-surfaceAlt p-4 rounded-lg border border-slate-700/50">
                            <p class="text-xs text-slate-400 uppercase tracking-widest mb-1">Weights</p>
                            <code class="text-sm text-fuchsia-300 break-all" id="model-weights">None</code>
                        </div>
                        <div class="bg-surfaceAlt p-4 rounded-lg border border-slate-700/50">
                            <p class="text-xs text-slate-400 uppercase tracking-widest mb-1">Intercept</p>
                            <code class="text-sm text-cyan-300" id="model-intercept">None</code>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Col: Agents & Privacy -->
            <div class="space-y-6">
                <div class="glass-card p-6">
                    <h2 class="text-lg font-semibold mb-4 text-slate-200">Live Agents registry</h2>
                    <ul id="agents-list" class="space-y-3">
                        <!-- Populated by JS -->
                        <li class="text-sm text-slate-500 italic text-center py-4">Waiting for agents...</li>
                    </ul>
                </div>

                <div class="glass-card p-6">
                    <h2 class="text-lg font-semibold mb-2 text-slate-200">Privacy Firewall</h2>
                    <p class="text-xs text-slate-400 mb-4">Tracking differential privacy Îµ budget, clipping norm, and
                        schema validation.</p>
                    <div class="bg-surfaceAlt rounded-lg p-5 border border-slate-700/50 flex items-center gap-4">
                        <div
                            class="h-12 w-12 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-slate-300">Secure Aggregation</p>
                            <p class="text-xs text-emerald-400 mt-1">Active (No Raw Data Exposed)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Chart Initialization
        const ctx = document.getElementById('convChart').getContext('2d');
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.font.family = 'Outfit';

        const convChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Accuracy',
                        data: [],
                        borderColor: '#34d399',
                        backgroundColor: 'rgba(52, 211, 153, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        yAxisID: 'y',
                        fill: true
                    },
                    {
                        label: 'Log Loss',
                        data: [],
                        borderColor: '#818cf8',
                        backgroundColor: 'rgba(129, 140, 248, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        yAxisID: 'y1',
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        title: { display: true, text: 'Federation Round' }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        title: { display: true, text: 'Accuracy' },
                        min: 0,
                        max: 1
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: 'Log Loss' }
                    }
                },
                plugins: {
                    legend: { position: 'top' }
                }
            }
        });

        // Data Polling
        async function fetchState() {
            try {
                const res = await fetch('/api/state');
                const data = await res.json();
                updateDashboard(data);
            } catch (err) {
                console.error("Failed to fetch state:", err);
            }
        }

        function updateDashboard(data) {
            // Status Updates
            const stText = document.getElementById('global-status-text');
            const stDot = document.getElementById('global-status-dot');
            stText.innerText = `Status: ${data.status}`;

            const btnStart = document.getElementById('btnStart');
            const btnStop = document.getElementById('btnStop');
            const targetInput = document.getElementById('targetRounds');

            if (data.status.startsWith("Idle")) {
                stDot.className = "status-indicator status-idle";
                btnStart.classList.remove('hidden');
                btnStop.classList.add('hidden');
                targetInput.disabled = false;
                targetInput.classList.remove('opacity-50');
            } else if (data.status === "Aggregating" || data.status === "RoundSetup" || data.status === "Broadcasting" || data.status === "Initializing") {
                stDot.className = "status-indicator status-active";
                btnStart.classList.add('hidden');
                btnStop.classList.remove('hidden');
                targetInput.disabled = true;
                targetInput.classList.add('opacity-50');
            } else if (data.status === "Terminated") {
                stDot.className = "status-indicator status-error";
                btnStart.classList.remove('hidden');
                btnStop.classList.add('hidden');
                targetInput.disabled = false;
                targetInput.classList.remove('opacity-50');
            } else {
                stDot.className = "status-indicator status-idle";
            }

            // KPIs
            document.getElementById('round-current').innerText = data.current_round;
            document.getElementById('round-max').innerText = data.max_rounds || '-';
            document.getElementById('agents-count').innerText = data.total_agents;

            if (data.rounds_history && data.rounds_history.length > 0) {
                const latest = data.rounds_history[data.rounds_history.length - 1];
                document.getElementById('latest-acc').innerText = (latest.accuracy * 100).toFixed(1) + '%';
                document.getElementById('latest-loss').innerText = latest.loss.toFixed(3);

                // Update chart
                const labels = data.rounds_history.map(r => `R${r.round}`);
                const accData = data.rounds_history.map(r => r.accuracy);
                const lossData = data.rounds_history.map(r => r.loss);

                convChart.data.labels = labels;
                convChart.data.datasets[0].data = accData;
                convChart.data.datasets[1].data = lossData;
                convChart.update();
            }

            // Global Model Attributes
            if (data.global_model && data.global_model.weights) {
                const wtext = data.global_model.weights.map(w => w.toFixed(4)).join(', ');
                document.getElementById('model-weights').innerText = `[${wtext}]`;
            }
            if (data.global_model && data.global_model.intercept) {
                const itext = data.global_model.intercept.map(w => w.toFixed(4)).join(', ');
                document.getElementById('model-intercept').innerText = `[${itext}]`;
            }

            // Agents List
            const agentsList = document.getElementById('agents-list');
            if (data.connected_agents && data.connected_agents.length > 0) {
                agentsList.innerHTML = '';
                data.connected_agents.forEach(agent => {
                    const li = document.createElement('li');
                    li.className = "bg-surfaceAlt p-3 rounded-lg border border-slate-700/50 flex justify-between items-center";
                    li.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-xs font-bold text-slate-400 border border-slate-700">
                                ðŸ¤–
                            </div>
                            <span class="text-sm font-medium text-slate-200">${agent.split('@')[0]}</span>
                        </div>
                        <span class="text-xs bg-emerald-500/10 text-emerald-400 px-2 py-1 rounded-full border border-emerald-500/20">Online</span>
                    `;
                    agentsList.appendChild(li);
                });
            }
        }

        // Control API Calls
        async function startFederation() {
            const rounds = parseInt(document.getElementById('targetRounds').value) || 10;
            try {
                await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: 'start', max_rounds: rounds })
                });
                fetchState(); // Immediately fetch state to update UI
            } catch (err) {
                console.error("Failed to start federation:", err);
            }
        }

        async function stopFederation() {
            try {
                await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: 'stop' })
                });
                fetchState(); // Immediately fetch state to update UI
            } catch (err) {
                console.error("Failed to stop federation:", err);
            }
        }

        // Poll every 1.5 seconds
        setInterval(fetchState, 1500);
        fetchState();
    </script>
</body>

</html>